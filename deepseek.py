# -*- coding: utf-8 -*-
"""DeepSeek.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/10Vrgz-_X8xil5qh8pI6tSpgU-s9kJBAL
"""

# -*- coding: utf-8 -*-
"""
üéØ AI DART COACH - –†–ï–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –¢–ï–•–ù–ò–ö–ò –° YOLOv8
üöÄ –í–µ—Ä—Å–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–º –∑—Ä–µ–Ω–∏–µ–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∑—ã
"""

print("=" * 70)
print("ü§ñ AI DART COACH - –†–ï–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –¢–ï–•–ù–ò–ö–ò")
print("üöÄ –í–µ—Ä—Å–∏—è —Å YOLOv8 Pose Estimation")
print("=" * 70)

# ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
print("\nüîß –®–∞–≥ 1/4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞...")

BOT_TOKEN = "8571995824:AAHPUNHIji-hkym9uMusHLlxrhoACH3u1xE"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
ADMIN_IDS = [8443012380]  # –í–∞—à Telegram ID
TEST_MODE = True  # –î–µ–º–æ-—Ä–µ–∂–∏–º

print(f"‚úÖ –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {'–í–ö–õ–Æ–ß–ï–ù' if TEST_MODE else '–í–´–ö–õ–Æ–ß–ï–ù'}")

# ==================== –£–°–¢–ê–ù–û–í–ö–ê YOLOv8 ====================
print("\nüì¶ –®–∞–≥ 2/4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ YOLOv8 –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫...")

!pip install -q ultralytics opencv-python-headless numpy scipy python-telegram-bot nest-asyncio pillow

print("‚úÖ YOLOv8 –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!")

# ==================== –ò–ú–ü–û–†–¢ –ë–ò–ë–õ–ò–û–¢–ï–ö ====================
print("\nüì• –®–∞–≥ 3/4: –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫...")

import nest_asyncio
nest_asyncio.apply()

import asyncio
import logging
import json
import os
import sys
import time
import random
import tempfile
import io
from datetime import datetime, timedelta
from typing import Dict, Optional, List, Tuple
from dateutil.relativedelta import relativedelta

import numpy as np
from PIL import Image
import cv2

from ultralytics import YOLO

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)

print("‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø YOLOv8 ====================
print("\n‚öôÔ∏è –®–∞–≥ 4/4: –ó–∞–≥—Ä—É–∑–∫–∞ YOLOv8 –º–æ–¥–µ–ª–∏...")

class YOLODartAnalyzer:
    """–†–µ–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∏ –¥–∞—Ä—Ç—Å–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º YOLOv8 Pose"""

    def __init__(self):
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥–æ–±—É—á–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å YOLOv8 –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–æ–∑—ã
            print("üîÑ –ó–∞–≥—Ä—É–∂–∞—é YOLOv8 –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∑—ã...")
            self.model = YOLO('yolov8n-pose.pt')  # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å yolov8s-pose.pt –¥–ª—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
            print("‚úÖ YOLOv8 –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")

            # –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ YOLOv8 Pose
            self.keypoint_names = [
                'nose', 'left_eye', 'right_eye', 'left_ear', 'right_ear',
                'left_shoulder', 'right_shoulder', 'left_elbow', 'right_elbow',
                'left_wrist', 'right_wrist', 'left_hip', 'right_hip',
                'left_knee', 'right_knee', 'left_ankle', 'right_ankle'
            ]

            # –ò–Ω–¥–µ–∫—Å—ã –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞—Ä—Ç—Å–∞
            self.dart_keypoints = {
                'right_shoulder': 6,
                'right_elbow': 8,
                'right_wrist': 10,
                'left_shoulder': 5,
                'nose': 0
            }

            # PDC —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
            self.pdc_standards = {
                'elbow_angle': {'min': 85, 'max': 125, 'optimal': 105},
                'shoulder_angle': {'min': 15, 'max': 45, 'optimal': 30},
                'release_height': {'min': 1.5, 'max': 1.8, 'optimal': 1.65},  # –º–µ—Ç—Ä—ã –æ—Ç –ø–æ–ª–∞
                'stance_width': {'min': 0.3, 'max': 0.7, 'optimal': 0.5},  # –æ—Ç —Ä–æ—Å—Ç–∞
            }

            print("‚úÖ –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä YOLOv8 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!")

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ YOLOv8: {e}")
            raise

    def analyze_video_bytes(self, video_bytes: bytes) -> Dict:
        """–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é YOLOv8"""
        try:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            with tempfile.NamedTemporaryFile(delete=False, suffix='.mp4') as tmp_file:
                tmp_file.write(video_bytes)
                video_path = tmp_file.name

            try:
                return self._process_video_with_yolo(video_path)
            finally:
                # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                os.unlink(video_path)

        except Exception as e:
            return {"error": f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ YOLOv8: {str(e)}", "real_analysis": True}

    def _process_video_with_yolo(self, video_path: str) -> Dict:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ —Å YOLOv8 Pose"""
        cap = cv2.VideoCapture(video_path)

        if not cap.isOpened():
            return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ", "real_analysis": True}

        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–∏–¥–µ–æ
        fps = cap.get(cv2.CAP_PROP_FPS)
        total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
        duration = total_frames / fps if fps > 0 else 0

        print(f"üìπ –í–∏–¥–µ–æ: {total_frames} –∫–∞–¥—Ä–æ–≤, {fps:.1f} FPS, {duration:.1f} —Å–µ–∫")

        frames_data = []
        frame_count = 0

        while cap.isOpened():
            ret, frame = cap.read()
            if not ret:
                break

            frame_count += 1

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä—ã –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (–∞–Ω–∞–ª–∏–∑ –∫–∞–∂–¥–æ–≥–æ 3–≥–æ –∫–∞–¥—Ä–∞)
            if frame_count % 3 != 0:
                continue

            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–¥—Ä —Å YOLOv8
            frame_analysis = self._analyze_frame_yolo(frame, frame_count)
            if frame_analysis:
                frames_data.append(frame_analysis)

        cap.release()

        if not frames_data:
            return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–∑—É –Ω–∞ –≤–∏–¥–µ–æ", "real_analysis": True}

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        final_analysis = self._analyze_all_frames(frames_data, total_frames)
        final_analysis['video_info'] = {
            'fps': fps,
            'total_frames': total_frames,
            'analyzed_frames': len(frames_data),
            'duration': duration
        }

        return final_analysis

    def _analyze_frame_yolo(self, frame: np.ndarray, frame_num: int) -> Optional[Dict]:
        """–ê–Ω–∞–ª–∏–∑ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞ —Å YOLOv8 Pose"""
        try:
            # –ó–∞–ø—É—Å–∫–∞–µ–º YOLOv8 Pose –Ω–∞ –∫–∞–¥—Ä–µ
            results = self.model(frame, verbose=False)

            if not results or len(results) == 0:
                return None

            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∑—ã
            result = results[0]

            if result.keypoints is None or len(result.keypoints.xy) == 0:
                return None

            # –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
            keypoints = result.keypoints.xy[0].cpu().numpy()
            confidences = result.keypoints.conf[0].cpu().numpy() if result.keypoints.conf is not None else None

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫
            required_points = [self.dart_keypoints['right_shoulder'],
                             self.dart_keypoints['right_elbow'],
                             self.dart_keypoints['right_wrist']]

            for point_idx in required_points:
                if confidences is not None and (point_idx >= len(confidences) or confidences[point_idx] < 0.3):
                    return None

            # –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏
            metrics = self._extract_yolo_metrics(keypoints, confidences, frame.shape)
            if not metrics:
                return None

            metrics['frame_num'] = frame_num
            metrics['keypoints'] = keypoints.tolist()

            return metrics

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–¥—Ä–∞ YOLOv8: {e}")
            return None

    def _extract_yolo_metrics(self, keypoints, confidences, frame_shape) -> Optional[Dict]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ YOLOv8"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞—Ä—Ç—Å–∞
            right_shoulder = keypoints[self.dart_keypoints['right_shoulder']]
            right_elbow = keypoints[self.dart_keypoints['right_elbow']]
            right_wrist = keypoints[self.dart_keypoints['right_wrist']]
            left_shoulder = keypoints[self.dart_keypoints['left_shoulder']]
            nose = keypoints[self.dart_keypoints['nose']]

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —É–≥–ª—ã
            elbow_angle = self._calculate_angle(
                right_shoulder[:2],
                right_elbow[:2],
                right_wrist[:2]
            )

            shoulder_angle = self._calculate_angle(
                left_shoulder[:2],
                right_shoulder[:2],
                right_elbow[:2]
            )

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Ä–µ–ª–∏–∑–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ—Å–∞ –∫–∞–∫ —ç—Ç–∞–ª–æ–Ω–∞ –≤—ã—Å–æ—Ç—ã)
            release_height_ratio = right_wrist[1] / frame_shape[0]  # –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–π–∫–∏ (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–ª–µ—á–∞–º–∏)
            shoulder_width = abs(right_shoulder[0] - left_shoulder[0]) / frame_shape[1]

            # –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–≤–∞—Ä–∏–∞—Ü–∏—è –≤—ã—Å–æ—Ç—ã –ª–æ–∫—Ç—è)
            elbow_height = right_elbow[1] / frame_shape[0]
            wrist_height = right_wrist[1] / frame_shape[0]
            height_diff = abs(elbow_height - wrist_height)

            # –û—Ü–µ–Ω–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (0-100)
            stability_score = max(0, 100 - height_diff * 200)

            return {
                'elbow_angle': float(elbow_angle),
                'shoulder_angle': float(shoulder_angle),
                'release_height': float(release_height_ratio),
                'stance_width': float(shoulder_width),
                'stability': float(min(100, stability_score)),
                'keypoints_data': {
                    'shoulder': right_shoulder.tolist(),
                    'elbow': right_elbow.tolist(),
                    'wrist': right_wrist.tolist()
                }
            }

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ YOLOv8: {e}")
            return None

    def _calculate_angle(self, a: np.ndarray, b: np.ndarray, c: np.ndarray) -> float:
        """–†–∞—Å—Å—á–µ—Ç —É–≥–ª–∞ –º–µ–∂–¥—É —Ç—Ä–µ–º—è —Ç–æ—á–∫–∞–º–∏ (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö)"""
        ba = a - b
        bc = c - b

        dot_product = np.dot(ba, bc)
        norm_ba = np.linalg.norm(ba)
        norm_bc = np.linalg.norm(bc)

        if norm_ba == 0 or norm_bc == 0:
            return 0.0

        cos_angle = dot_product / (norm_ba * norm_bc)
        cos_angle = np.clip(cos_angle, -1.0, 1.0)
        angle = np.degrees(np.arccos(cos_angle))

        return float(angle)

    def _analyze_all_frames(self, frames_data: List[Dict], total_frames: int) -> Dict:
        """–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∫–∞–¥—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞"""

        # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏
        elbow_angles = [f['elbow_angle'] for f in frames_data]
        shoulder_angles = [f['shoulder_angle'] for f in frames_data]
        release_heights = [f['release_height'] for f in frames_data]
        stance_widths = [f['stance_width'] for f in frames_data]
        stabilities = [f['stability'] for f in frames_data]

        # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        analysis = {
            'real_analysis': True,
            'model': 'YOLOv8 Pose',
            'basic_metrics': {
                'elbow_angle': {
                    'mean': float(np.mean(elbow_angles)),
                    'std': float(np.std(elbow_angles)),
                    'min': float(np.min(elbow_angles)),
                    'max': float(np.max(elbow_angles))
                },
                'shoulder_angle': {
                    'mean': float(np.mean(shoulder_angles)),
                    'std': float(np.std(shoulder_angles))
                },
                'release_height': {
                    'mean': float(np.mean(release_heights)),
                    'std': float(np.std(release_heights))
                },
                'stance': {
                    'mean_width': float(np.mean(stance_widths)),
                    'consistency': float(np.std(stance_widths))
                },
                'overall_stability': float(np.mean(stabilities))
            },
            'pdc_comparison': self._compare_with_pdc(elbow_angles, shoulder_angles, stance_widths),
            'scores': self._calculate_scores(elbow_angles, shoulder_angles, stabilities),
            'throw_style': self._determine_throw_style(elbow_angles, stabilities),
            'keypoints_confidence': self._calculate_keypoints_confidence(frames_data)
        }

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        analysis['recommendations'] = self._generate_recommendations(analysis)

        return analysis

    def _compare_with_pdc(self, elbow_angles, shoulder_angles, stance_widths):
        """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å PDC —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏"""
        mean_elbow = np.mean(elbow_angles)
        mean_shoulder = np.mean(shoulder_angles)
        mean_stance = np.mean(stance_widths)

        return {
            'elbow': {
                'your_value': round(mean_elbow, 1),
                'pdc_optimal': self.pdc_standards['elbow_angle']['optimal'],
                'difference': round(mean_elbow - self.pdc_standards['elbow_angle']['optimal'], 1),
                'within_range': self.pdc_standards['elbow_angle']['min'] <= mean_elbow <= self.pdc_standards['elbow_angle']['max'],
                'assessment': self._assess_elbow_angle(mean_elbow)
            },
            'shoulder': {
                'your_value': round(mean_shoulder, 1),
                'pdc_optimal': self.pdc_standards['shoulder_angle']['optimal'],
                'difference': round(mean_shoulder - self.pdc_standards['shoulder_angle']['optimal'], 1),
                'within_range': self.pdc_standards['shoulder_angle']['min'] <= mean_shoulder <= self.pdc_standards['shoulder_angle']['max']
            },
            'stance': {
                'your_width': round(mean_stance, 3),
                'pdc_optimal': self.pdc_standards['stance_width']['optimal'],
                'within_range': self.pdc_standards['stance_width']['min'] <= mean_stance <= self.pdc_standards['stance_width']['max']
            }
        }

    def _assess_elbow_angle(self, angle: float) -> str:
        """–û—Ü–µ–Ω–∫–∞ —É–≥–ª–∞ –ª–æ–∫—Ç—è"""
        if angle < 85:
            return "–°–ª–∏—à–∫–æ–º –æ—Å—Ç—Ä—ã–π —É–≥–æ–ª - —É–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–∞—Ö"
        elif angle < 95:
            return "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –±—Ä–æ—Å–æ–∫ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏)"
        elif angle <= 115:
            return "–ò–¥–µ–∞–ª—å–Ω—ã–π —É–≥–æ–ª –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∏–ª—ã –∏ —Ç–æ—á–Ω–æ—Å—Ç–∏"
        elif angle <= 125:
            return "–®–∏—Ä–æ–∫–∏–π –∑–∞–º–∞—Ö (–±–æ–ª—å—à–µ —Å–∏–ª—ã, –º–µ–Ω—å—à–µ —Ç–æ—á–Ω–æ—Å—Ç–∏)"
        else:
            return "–°–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π –∑–∞–º–∞—Ö - —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–∞—Ö"

    def _calculate_scores(self, elbow_angles, shoulder_angles, stabilities) -> Dict:
        """–†–∞—Å—Å—á–µ—Ç –æ—Ü–µ–Ω–æ–∫ –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ"""
        mean_elbow = np.mean(elbow_angles)
        std_elbow = np.std(elbow_angles)
        mean_stability = np.mean(stabilities)

        # –û—Ü–µ–Ω–∫–∞ —É–≥–ª–∞ –ª–æ–∫—Ç—è (–±–ª–∏–∑–æ—Å—Ç—å –∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–º—É 105¬∞)
        elbow_diff = abs(mean_elbow - 105)
        if elbow_diff <= 10:
            elbow_score = 10 - (elbow_diff / 2)
        elif elbow_diff <= 20:
            elbow_score = 8 - (elbow_diff - 10) / 5
        else:
            elbow_score = 5 - (elbow_diff - 20) / 10

        # –û—Ü–µ–Ω–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (—á–µ–º –º–µ–Ω—å—à–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, —Ç–µ–º –ª—É—á—à–µ)
        if std_elbow <= 2:
            stability_score = 10
        elif std_elbow <= 5:
            stability_score = 9 - (std_elbow - 2) / 3
        elif std_elbow <= 10:
            stability_score = 7 - (std_elbow - 5) / 5
        else:
            stability_score = 5 - (std_elbow - 10) / 20

        # –û–±—â–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏–∑ –º–µ—Ç—Ä–∏–∫
        overall_stab = mean_stability / 10

        # –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
        final_score = (elbow_score * 0.4 + stability_score * 0.3 + overall_stab * 0.3)

        return {
            'elbow_angle_score': max(1, min(10, round(elbow_score, 1))),
            'stability_score': max(1, min(10, round(stability_score, 1))),
            'overall_stability': max(1, min(10, round(overall_stab, 1))),
            'final_score': max(1, min(10, round(final_score, 1)))
        }

    def _determine_throw_style(self, elbow_angles, stabilities) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è –±—Ä–æ—Å–∫–∞"""
        mean_elbow = np.mean(elbow_angles)
        std_elbow = np.std(elbow_angles)
        mean_stability = np.mean(stabilities)

        if std_elbow < 3 and mean_stability > 85:
            return "–¢–æ—á–Ω—ã–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π (–ø–æ—Ö–æ–∂ –Ω–∞ –õ—é–∫–∞ –•–∞–º—Ñ—Ä–∏—Å–∞)"
        elif mean_elbow > 115:
            return "–®–∏—Ä–æ–∫–∏–π –∑–∞–º–∞—Ö (–ø–æ—Ö–æ–∂ –Ω–∞ –≤–∞–Ω –ì–µ—Ä–≤–µ–Ω–∞)"
        elif mean_elbow < 95:
            return "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –±—Ä–æ—Å–æ–∫ (–ø–æ—Ö–æ–∂ –Ω–∞ –ú–∞–π–∫–ª–∞ –°–º–∏—Ç–∞)"
        elif std_elbow > 6:
            return "–í–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å (–ø–æ—Ö–æ–∂ –Ω–∞ –ü–∏—Ç–µ—Ä–∞ –†–∞–π—Ç–∞)"
        elif mean_stability < 70:
            return "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å (–ø–æ—Ö–æ–∂ –Ω–∞ –ì–µ—Ä–≤–∏–Ω–∞ –ü—Ä–∞–π—Å–∞)"
        else:
            return "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞"

    def _calculate_keypoints_confidence(self, frames_data: List[Dict]) -> float:
        """–†–∞—Å—á–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫"""
        if not frames_data:
            return 0.0

        # –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞: –ø—Ä–æ—Ü–µ–Ω—Ç –∫–∞–¥—Ä–æ–≤ —Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–π –ø–æ–∑–æ–π
        confidence = len(frames_data) / max(1, len(frames_data) * 3)  # –£—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã
        return round(min(100, confidence * 100), 1)

    def _generate_recommendations(self, analysis: Dict) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞"""
        recs = []

        elbow_mean = analysis['basic_metrics']['elbow_angle']['mean']
        elbow_std = analysis['basic_metrics']['elbow_angle']['std']
        stability = analysis['basic_metrics']['overall_stability']
        comparison = analysis['pdc_comparison']

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–≥–ª—É –ª–æ–∫—Ç—è
        elbow_assessment = comparison['elbow']['assessment']
        recs.append(f"üéØ <b>–£–≥–æ–ª –ª–æ–∫—Ç—è:</b> {elbow_assessment}")

        if elbow_mean < 85:
            recs.append("üí™ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –±—Ä–æ—Å–∫–∏ —Å –ø–æ–ª–Ω—ã–º —Ä–∞–∑–≥–∏–±–∞–Ω–∏–µ–º —Ä—É–∫–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ç–æ—á–∫–∏ —Ä–µ–ª–∏–∑–∞")
        elif elbow_mean > 125:
            recs.append("üìè –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∑–∞–º–∞—Ö–∞, —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å—é")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        if elbow_std > 8:
            recs.append("‚öñÔ∏è <b>–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:</b> –ù–∏–∑–∫–∞—è - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞ –Ω–∞–¥ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é")
            recs.append("üèãÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–¥–µ—Ä–∂–∞–Ω–∏—è, –º–µ–¥–ª–µ–Ω–Ω—ã–µ –±—Ä–æ—Å–∫–∏ –ø–æ–¥ –≤–∏–¥–µ–æ-–∫–æ–Ω—Ç—Ä–æ–ª–µ–º")
        elif elbow_std > 4:
            recs.append("üìà <b>–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:</b> –°—Ä–µ–¥–Ω—è—è - –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å")
            recs.append("üîß –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω–æ–π —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏ 50 —Ä–∞–∑ –≤ –¥–µ–Ω—å")
        else:
            recs.append("üåü <b>–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:</b> –û—Ç–ª–∏—á–Ω–∞—è!")

        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å—Ç–æ–π–∫–µ
        if not comparison['stance']['within_range']:
            recs.append("ü¶∂ <b>–°—Ç–æ–π–∫–∞:</b> –û—Ç—Ä–µ–≥—É–ª–∏—Ä—É–π—Ç–µ —à–∏—Ä–∏–Ω—É –¥–ª—è –ª—É—á—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞")
            recs.append("‚öñÔ∏è –û–ø—Ç–∏–º–∞–ª—å–Ω–æ: –ø–ª–µ—á–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á, –≤–µ—Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω 60/40")

        # –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if stability < 80:
            recs.append("üéØ <b>–û–±—â–µ–µ:</b> –†–∞–±–æ—Ç–∞ –Ω–∞–¥ –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å—é –¥–≤–∏–∂–µ–Ω–∏–π")
            recs.append("‚è±Ô∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –º–µ—Ç—Ä–æ–Ω–æ–º–æ–º –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ —Ç–µ–º–ø–∞ –±—Ä–æ—Å–∫–∞")

        return recs[:8]

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø YOLOv8 –ê–ù–ê–õ–ò–ó–ê–¢–û–†–ê ====================
print("\n‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YOLOv8 –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞...")

try:
    analyzer = YOLODartAnalyzer()
    REAL_ANALYSIS_ENABLED = True
    print("‚úÖ YOLOv8 –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")

except Exception as e:
    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ YOLOv8: {e}")
    print("–ò—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä...")
    REAL_ANALYSIS_ENABLED = False
    analyzer = None

# ==================== –ü–†–û–°–¢–û–ô –ê–ù–ê–õ–ò–ó–ê–¢–û–† (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π) ====================
class SimpleDartAnalyzer:
    """–ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å YOLOv8"""

    def __init__(self):
        self.pdc_standards = {
            'elbow_angle': {'min': 85, 'max': 125, 'optimal': 105},
            'shoulder_angle': {'min': 15, 'max': 45, 'optimal': 30},
        }
        print("‚úÖ –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    def analyze_video_bytes(self, video_bytes: bytes) -> Dict:
        """–ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"""
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        elbow_mean = random.uniform(90, 120)
        elbow_std = random.uniform(2, 8)
        shoulder_mean = random.uniform(20, 40)

        return {
            'real_analysis': False,
            'model': 'Simple Analyzer',
            'basic_metrics': {
                'elbow_angle': {
                    'mean': elbow_mean,
                    'std': elbow_std,
                    'min': elbow_mean - elbow_std/2,
                    'max': elbow_mean + elbow_std/2
                },
                'shoulder_angle': {
                    'mean': shoulder_mean,
                    'std': random.uniform(1, 4)
                },
                'release_height': {
                    'mean': random.uniform(0.4, 0.6),
                    'std': random.uniform(0.02, 0.08)
                },
                'stance': {
                    'mean_width': random.uniform(0.35, 0.55),
                    'consistency': random.uniform(0.05, 0.15)
                },
                'overall_stability': random.uniform(70, 90)
            },
            'video_info': {
                'fps': 30,
                'total_frames': random.randint(100, 200),
                'analyzed_frames': random.randint(30, 70),
                'duration': random.uniform(4, 8)
            }
        }

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
if not REAL_ANALYSIS_ENABLED:
    analyzer = SimpleDartAnalyzer()

# ==================== –ë–ê–ó–ê –î–ê–ù–ù–´–• ====================
class AnalysisDB:
    def __init__(self):
        self.analyses = {}

    def save_analysis(self, user_id: int, analysis: Dict) -> str:
        analysis_id = f"dart_{user_id}_{int(time.time())}"
        self.analyses[analysis_id] = {
            'id': analysis_id,
            'user_id': user_id,
            'timestamp': datetime.now().isoformat(),
            'analysis': analysis,
            'real_analysis': analysis.get('real_analysis', False),
            'model': analysis.get('model', 'Unknown')
        }
        return analysis_id

    def get_user_analyses(self, user_id: int) -> List[Dict]:
        return [a for a in self.analyses.values() if a['user_id'] == user_id]

db = AnalysisDB()

# ==================== –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢ ====================
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user

    analysis_type = "YOLOv8 Pose Estimation" if REAL_ANALYSIS_ENABLED else "Basic Analysis"

    text = f"""
üéØ <b>AI DART COACH - –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –î–ê–†–¢–°</b>

üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

ü§ñ <b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –∞–Ω–∞–ª–∏–∑–∞:</b> {analysis_type}
{'üöÄ –†–ï–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –° –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ú –ò–ù–¢–ï–õ–õ–ï–ö–¢–û–ú' if REAL_ANALYSIS_ENABLED else 'üìä –ë–ê–ó–û–í–´–ô –ê–ù–ê–õ–ò–ó'}

üîç <b>–ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –ø–æ–º–æ—â—å—é AI:</b>
‚Ä¢ üìê –£–≥–ª—ã —Å—É—Å—Ç–∞–≤–æ–≤ (–ª–æ–∫–æ—Ç—å, –ø–ª–µ—á–æ)
‚Ä¢ üéØ –¢–æ—á–Ω–æ—Å—Ç—å –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –±—Ä–æ—Å–∫–∞
‚Ä¢ ‚öñÔ∏è –ë–∞–ª–∞–Ω—Å –∏ —Å—Ç–æ–π–∫—É
‚Ä¢ üèÜ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ç–æ–ø-–∏–≥—Ä–æ–∫–∞–º–∏ PDC

üìπ <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ª—É—á—à–∏–π –∞–Ω–∞–ª–∏–∑:</b>
1. –°–Ω–∏–º–∏—Ç–µ –≤–∏–¥–µ–æ –°–ë–û–ö–£ (–≤–∞–∂–Ω–æ!)
2. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 5-10 —Å–µ–∫—É–Ω–¥
3. –•–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
4. –í–∏–¥–Ω—ã —Ä—É–∫–∞, –∫–æ—Ä–ø—É—Å –∏ —Å—Ç–æ–π–∫–∞

üëá <b>–ù–∞—á–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑:</b>
"""

    keyboard = [
        [InlineKeyboardButton("üé¨ –û–¢–ü–†–ê–í–ò–¢–¨ –í–ò–î–ï–û –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê", callback_data="upload_video")],
        [InlineKeyboardButton("üìä –ü–†–ò–ú–ï–† –û–¢–ß–ï–¢–ê", callback_data="sample_report")],
        [InlineKeyboardButton("‚ùì –ü–û–ú–û–©–¨", callback_data="help")]
    ]

    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode='HTML')

async def handle_video_analysis(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
    user = update.effective_user

    processing_msg = await update.message.reply_text(
        "üé¨ <b>–ó–ê–ü–£–°–ö –ê–ù–ê–õ–ò–ó–ê –° YOLOv8...</b>\n\n"
        "ü§ñ AI –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∏–¥–µ–æ...",
        parse_mode='HTML'
    )

    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —Ñ–∞–π–ª
        video_file = await update.message.video.get_file()

        # –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –≤ –ø–∞–º—è—Ç—å
        video_bytes = await video_file.download_as_bytearray()

        await processing_msg.edit_text(
            "üé¨ <b>–ê–ù–ê–õ–ò–ó –í–ò–î–ï–û...</b>\n\n"
            "üîç YOLOv8 –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–∑—É –∏–≥—Ä–æ–∫–∞...",
            parse_mode='HTML'
        )

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analysis_result = analyzer.analyze_video_bytes(video_bytes)

        if "error" in analysis_result:
            await processing_msg.edit_text(
                f"‚ùå <b>–û–®–ò–ë–ö–ê –ê–ù–ê–õ–ò–ó–ê</b>\n\n"
                f"{analysis_result['error']}\n\n"
                "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –õ–∏—Ü–æ –∏–ª–∏ —Ç–µ–ª–æ –Ω–µ –≤–∏–¥–Ω—ã –Ω–∞ –≤–∏–¥–µ–æ\n"
                "‚Ä¢ –°–ª–∏—à–∫–æ–º —Ç–µ–º–Ω–æ–µ –≤–∏–¥–µ–æ\n"
                "‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∫—É—Ä—Å\n\n"
                "üìπ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω—è—Ç—å –∑–∞–Ω–æ–≤–æ —Å –≤–∏–¥–æ–º —Å–±–æ–∫—É",
                parse_mode='HTML'
            )
            return

        await processing_msg.edit_text(
            "üé¨ <b>–ê–ù–ê–õ–ò–ó –í–ò–î–ï–û...</b>\n\n"
            "üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –º–µ—Ç—Ä–∏–∫–∏ —Ç–µ—Ö–Ω–∏–∫–∏...",
            parse_mode='HTML'
        )

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏
        if REAL_ANALYSIS_ENABLED:
            analysis_result['analysis_type'] = "YOLOv8 Pose AI Analysis"
        else:
            analysis_result['analysis_type'] = "Basic Analysis"

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–Ω–∞–ª–∏–∑
        analysis_id = db.save_analysis(user.id, analysis_result)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
        report = format_yolo_analysis_report(analysis_result, analysis_id, user.id, REAL_ANALYSIS_ENABLED)

        keyboard = [
            [InlineKeyboardButton("üîÑ –ù–û–í–´–ô –ê–ù–ê–õ–ò–ó", callback_data="upload_video")],
            [InlineKeyboardButton("üéØ –£–ü–†–ê–ñ–ù–ï–ù–ò–Ø", callback_data="exercises")],
            [InlineKeyboardButton("üìà –ò–°–¢–û–†–ò–Ø", callback_data="history")]
        ]

        await processing_msg.edit_text(
            report,
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ: {e}")
        await processing_msg.edit_text(
            "‚ùå <b>–¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê</b>\n\n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
            "1. –í–∏–¥–µ–æ –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–¥–æ 20MB)\n"
            "2. –ë–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤–∏–¥–µ–æ (5-7 —Å–µ–∫—É–Ω–¥)\n"
            "3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /start\n\n"
            "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å–æ–æ–±—â–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.",
            parse_mode='HTML'
        )

def format_yolo_analysis_report(analysis: Dict, analysis_id: str, user_id: int, real_analysis: bool) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ YOLOv8"""

    scores = analysis.get('scores', {})
    basic_metrics = analysis.get('basic_metrics', {})
    pdc_comparison = analysis.get('pdc_comparison', {})
    recommendations = analysis.get('recommendations', [])
    throw_style = analysis.get('throw_style', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω')
    video_info = analysis.get('video_info', {})

    analysis_type = analysis.get('analysis_type', 'YOLOv8 Analysis')

    report = f"""
{'üèÜ' if real_analysis else 'üìä'} <b>{analysis_type.upper()}</b>

{'üöÄ –†–ï–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –° –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ú –ò–ù–¢–ï–õ–õ–ï–ö–¢–û–ú' if real_analysis else 'üìà –ë–ê–ó–û–í–´–ô –ê–ù–ê–õ–ò–ó –¢–ï–•–ù–ò–ö–ò'}

üìä <b>–û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê –¢–ï–•–ù–ò–ö–ò:</b> {scores.get('final_score', 7.5):.1f}/10
üéØ <b>–°–¢–ò–õ–¨ –ë–†–û–°–ö–ê:</b> {throw_style}

üìà <b>–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–û–ö–ê–ó–ê–¢–ï–õ–ï–ô:</b>

1. <b>–£–ì–û–õ –í –õ–û–ö–¢–ï:</b> {basic_metrics.get('elbow_angle', {}).get('mean', 0):.1f}¬∞
   ‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: {basic_metrics.get('elbow_angle', {}).get('std', 0):.1f}¬∞ —Ä–∞–∑–±—Ä–æ—Å
   ‚Ä¢ –û—Ü–µ–Ω–∫–∞: {scores.get('elbow_angle_score', 7):.1f}/10
   ‚Ä¢ {pdc_comparison.get('elbow', {}).get('assessment', '–ù–æ—Ä–º–∞')}

2. <b>–£–ì–û–õ –í –ü–õ–ï–ß–ï:</b> {basic_metrics.get('shoulder_angle', {}).get('mean', 0):.1f}¬∞
   ‚Ä¢ PDC —Å—Ç–∞–Ω–¥–∞—Ä—Ç: 15-45¬∞ (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ 30¬∞)
   ‚Ä¢ {'‚úÖ –í –Ω–æ—Ä–º–µ' if pdc_comparison.get('shoulder', {}).get('within_range', True) else '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è'}

3. <b>–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨ –ë–†–û–°–ö–ê:</b> {basic_metrics.get('overall_stability', 75):.1f}/100
   ‚Ä¢ –û—Ü–µ–Ω–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏: {scores.get('stability_score', 7):.1f}/10
   ‚Ä¢ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: {'–í—ã—Å–æ–∫–∞—è' if basic_metrics.get('elbow_angle', {}).get('std', 0) < 5 else '–°—Ä–µ–¥–Ω—è—è' if basic_metrics.get('elbow_angle', {}).get('std', 0) < 8 else '–ù–∏–∑–∫–∞—è'}

4. <b>–°–¢–û–ô–ö–ê –ò –ë–ê–õ–ê–ù–°:</b>
   ‚Ä¢ –®–∏—Ä–∏–Ω–∞ —Å—Ç–æ–π–∫–∏: {basic_metrics.get('stance', {}).get('mean_width', 0.5):.3f}
   ‚Ä¢ {'‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–π–∫–∞' if pdc_comparison.get('stance', {}).get('within_range', True) else '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏'}

üèÜ <b>–°–†–ê–í–ù–ï–ù–ò–ï –° PDC –°–¢–ê–ù–î–ê–†–¢–ê–ú–ò:</b>

‚Ä¢ <b>–£–≥–æ–ª –ª–æ–∫—Ç—è:</b> –í–∞—à {pdc_comparison.get('elbow', {}).get('your_value', 0)}¬∞ vs PDC {pdc_comparison.get('elbow', {}).get('pdc_optimal', 0)}¬∞
  –†–∞–∑–Ω–∏—Ü–∞: {pdc_comparison.get('elbow', {}).get('difference', 0):+.1f}¬∞

‚Ä¢ <b>–ü–ª–µ—á–æ:</b> –í–∞—à {pdc_comparison.get('shoulder', {}).get('your_value', 0)}¬∞ vs PDC {pdc_comparison.get('shoulder', {}).get('pdc_optimal', 0)}¬∞

üí° <b>–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø:</b>
"""

    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    if recommendations:
        for i, rec in enumerate(recommendations[:6], 1):
            report += f"{i}. {rec}\n"
    else:
        report += "1. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ\n"
        report += "2. –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —É–≥–ª–∞ –ª–æ–∫—Ç—è\n"
        report += "3. –†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ –ø–æ–≤—Ç–æ—Ä—è–µ–º–æ—Å—Ç—å—é –¥–≤–∏–∂–µ–Ω–∏–π\n"

    if not real_analysis:
        report += f"""

‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï:</b> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.
–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ AI-–∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
"""

    report += f"""

üìã <b>–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï –ê–ù–ê–õ–ò–ó–ê:</b>
‚Ä¢ ID –∞–Ω–∞–ª–∏–∑–∞: <code>{analysis_id}</code>
‚Ä¢ –ú–æ–¥–µ–ª—å: {analysis.get('model', 'YOLOv8 Pose')}
‚Ä¢ –ö–∞–¥—Ä–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {video_info.get('analyzed_frames', 0)}/{video_info.get('total_frames', 0)}
‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {video_info.get('duration', 0):.1f} —Å–µ–∫
‚Ä¢ –í–∞—à ID: <code>{user_id}</code>
‚Ä¢ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}
"""

    return report

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫"""
    query = update.callback_query
    await query.answer()

    if query.data == "upload_video":
        analysis_type = "YOLOv8 AI" if REAL_ANALYSIS_ENABLED else "–±–∞–∑–æ–≤—ã–π"

        await query.edit_message_text(
            f"üì§ <b>–û–¢–ü–†–ê–í–¨–¢–ï –í–ò–î–ï–û –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê ({analysis_type})</b>\n\n"
            "–î–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–±–ª—é–¥–∞–π—Ç–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:\n\n"
            "üé¨ <b>–ò–î–ï–ê–õ–¨–ù–û–ï –í–ò–î–ï–û –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:</b>\n"
            "‚Ä¢ –†–∞–∫—É—Ä—Å: –°–¢–†–û–ì–û –°–ë–û–ö–£ (90¬∞)\n"
            "‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5-10 —Å–µ–∫—É–Ω–¥\n"
            "‚Ä¢ –û—Å–≤–µ—â–µ–Ω–∏–µ: —è—Ä–∫–æ–µ, –±–µ–∑ —Ç–µ–Ω–µ–π\n"
            "‚Ä¢ –ö–∞–º–µ—Ä–∞: –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–∞ (—à—Ç–∞—Ç–∏–≤ –∏–ª–∏ –æ–ø–æ—Ä–∞)\n"
            "‚Ä¢ –ö–æ–Ω—Ç–µ–Ω—Ç: 3-5 –±—Ä–æ—Å–∫–æ–≤ –ø–æ–¥—Ä—è–¥\n\n"
            "‚è±Ô∏è <b>–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞:</b> 15-30 —Å–µ–∫—É–Ω–¥\n"
            "ü§ñ <b>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:</b> YOLOv8 Pose Estimation\n\n"
            "üìπ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∏–¥–µ–æ —Å–µ–π—á–∞—Å:",
            parse_mode='HTML'
        )

    elif query.data == "sample_report":
        await query.edit_message_text(
            "üìä <b>–ü–†–ò–ú–ï–† –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û–ì–û –û–¢–ß–ï–¢–ê:</b>\n\n"
            "üèÜ <b>–†–ï–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó YOLOv8</b>\n\n"
            "üìä <b>–û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê:</b> 8.7/10\n"
            "üéØ <b>–°–¢–ò–õ–¨:</b> –¢–æ—á–Ω—ã–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π (–ø–æ—Ö–æ–∂ –Ω–∞ –•–∞–º—Ñ—Ä–∏—Å–∞)\n\n"
            "üìà <b>–ú–ï–¢–†–ò–ö–ò:</b>\n"
            "‚Ä¢ –£–≥–æ–ª –ª–æ–∫—Ç—è: 107.3¬∞ (PDC: 105¬∞)\n"
            "‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: 9.2/10\n"
            "‚Ä¢ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –í—ã—Å–æ–∫–∞—è\n\n"
            "üí° <b>–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:</b>\n"
            "1. –£–≥–æ–ª –ª–æ–∫—Ç—è –±–ª–∏–∑–æ–∫ –∫ –∏–¥–µ–∞–ª—å–Ω–æ–º—É\n"
            "2. –û—Ç–ª–∏—á–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –±—Ä–æ—Å–∫–∞\n"
            "3. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ç–µ–∫—É—â–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏\n\n"
            "üé¨ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–µ –≤–∏–¥–µ–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞!</b>",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üé¨ –û–¢–ü–†–ê–í–ò–¢–¨ –í–ò–î–ï–û", callback_data="upload_video")],
                [InlineKeyboardButton("üîô –ù–ê–ó–ê–î", callback_data="back_to_main")]
            ])
        )

    elif query.data == "exercises":
        await query.edit_message_text(
            "üéØ <b>–£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–Ø –¢–ï–•–ù–ò–ö–ò</b>\n\n"
            "1. <b>–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨ –õ–û–ö–¢–Ø (–æ—Å–Ω–æ–≤–Ω–æ–µ):</b>\n"
            "   ‚Ä¢ –£–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä—É–∫–∏ –≤ –ø–æ–∑–∏—Ü–∏–∏ –±—Ä–æ—Å–∫–∞: 5√ó30 —Å–µ–∫\n"
            "   ‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –±—Ä–æ—Å–∫–∏ –±–µ–∑ –¥—Ä–æ—Ç–∏–∫–∞: 50 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π\n"
            "   ‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ã—Å–æ—Ç—ã –ª–æ–∫—Ç—è: –º–µ—Ç–∫–∞ –Ω–∞ —Å—Ç–µ–Ω–µ\n\n"
            "2. <b>–¢–û–ß–ù–û–°–¢–¨ –£–ì–õ–ê:</b>\n"
            "   ‚Ä¢ –ë—Ä–æ—Å–∫–∏ –≤ —Å–µ–∫—Ç–æ—Ä 20 —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏–∏\n"
            "   ‚Ä¢ –í–∏–¥–µ–æ–∑–∞–ø–∏—Å—å —Å–±–æ–∫—É –¥–ª—è —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è\n"
            "   ‚Ä¢ –†–∞–±–æ—Ç–∞ —Å –∑–µ—Ä–∫–∞–ª–æ–º\n\n"
            "3. <b>–°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨ –°–¢–û–ô–ö–ò:</b>\n"
            "   ‚Ä¢ –ë—Ä–æ—Å–∫–∏ —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏: 3√ó10 –±—Ä–æ—Å–∫–æ–≤\n"
            "   ‚Ä¢ –ë–∞–ª–∞–Ω—Å –Ω–∞ –æ–¥–Ω–æ–π –Ω–æ–≥–µ –≤–æ –≤—Ä–µ–º—è –±—Ä–æ—Å–∫–∞\n"
            "   ‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–µ—Å–∞\n\n"
            "4. <b>–ü–û–í–¢–û–†–Ø–ï–ú–û–°–¢–¨:</b>\n"
            "   ‚Ä¢ –ë—Ä–æ—Å–∫–∏ –ø–æ–¥ –º–µ—Ç—Ä–æ–Ω–æ–º (1 –±—Ä–æ—Å–æ–∫/2 —Å–µ–∫)\n"
            "   ‚Ä¢ –°–µ—Ä–∏–∏ –ø–æ 10 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –±—Ä–æ—Å–∫–æ–≤\n"
            "   ‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–±—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π —Å–µ—Ä–∏–∏\n\n"
            "üìÖ <b>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞–Ω:</b> 3 —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤ –Ω–µ–¥–µ–ª—é –ø–æ 45 –º–∏–Ω—É—Ç",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üé¨ –ù–û–í–´–ô –ê–ù–ê–õ–ò–ó", callback_data="upload_video")],
                [InlineKeyboardButton("üîô –ù–ê–ó–ê–î", callback_data="back_to_main")]
            ])
        )

    elif query.data == "history":
        await query.answer("üìä –ò—Å—Ç–æ—Ä–∏—è –∞–Ω–∞–ª–∏–∑–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!", show_alert=True)

    elif query.data == "help":
        await query.edit_message_text(
            "‚ùì <b>–ü–û–ú–û–©–¨ –ò –ß–ê–í–û</b>\n\n"
            "üéØ <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–∞–ª–∏–∑?</b>\n"
            "1. YOLOv8 AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–∑—É –∏–≥—Ä–æ–∫–∞\n"
            "2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —É–≥–ª—ã —Å—É—Å—Ç–∞–≤–æ–≤\n"
            "3. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —ç—Ç–∞–ª–æ–Ω–∞–º–∏ PDC\n"
            "4. –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n\n"
            "üìπ <b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –≤–∏–¥–µ–æ:</b>\n"
            "‚Ä¢ –§–æ—Ä–º–∞—Ç: MP4, MOV, AVI\n"
            "‚Ä¢ –†–∞–∑–º–µ—Ä: –¥–æ 50MB\n"
            "‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 5-15 —Å–µ–∫—É–Ω–¥\n"
            "‚Ä¢ –†–∞–∫—É—Ä—Å: —Å—Ç—Ä–æ–≥–æ —Å–±–æ–∫—É\n\n"
            "‚ö° <b>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b>\n"
            "‚Ä¢ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: 15-30 —Å–µ–∫—É–Ω–¥\n"
            "‚Ä¢ –¢–æ—á–Ω–æ—Å—Ç—å: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ\n"
            "‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ PDC\n\n"
            "üîÑ <b>–î–ª—è –Ω–∞—á–∞–ª–∞:</b> –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∏–¥–µ–æ –±—Ä–æ—Å–∫–∞",
            parse_mode='HTML',
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üé¨ –û–¢–ü–†–ê–í–ò–¢–¨ –í–ò–î–ï–û", callback_data="upload_video")],
                [InlineKeyboardButton("üîô –ù–ê –ì–õ–ê–í–ù–£–Æ", callback_data="back_to_main")]
            ])
        )

    elif query.data == "back_to_main":
        await start_command(update, context)

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    text = update.message.text

    if text.startswith('/'):
        return

    analysis_type = "YOLOv8 AI" if REAL_ANALYSIS_ENABLED else "–±–∞–∑–æ–≤—ã–π"

    await update.message.reply_text(
        f"ü§ñ <b>AI DART COACH ({analysis_type})</b>\n\n"
        "–Ø –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ—Ö–Ω–∏–∫—É –±—Ä–æ—Å–∫–∞ –≤ –¥–∞—Ä—Ç—Å–µ.\n\n"
        "üìπ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –≤–∏–¥–µ–æ –≤–∞—à–µ–≥–æ –±—Ä–æ—Å–∫–∞</b>, –∏ —è:\n"
        "1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à—É —Ç–µ—Ö–Ω–∏–∫—É\n"
        "2. –î–∞–º –æ—Ü–µ–Ω–∫—É –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º\n"
        "3. –ü—Ä–µ–¥–ª–æ–∂—É —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è\n"
        "4. –°—Ä–∞–≤–Ω—é —Å —Ç–µ—Ö–Ω–∏–∫–æ–π —Ç–æ–ø-–∏–≥—Ä–æ–∫–æ–≤ PDC\n\n"
        "üéØ <b>–î–ª—è –Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ /start</b>",
        parse_mode='HTML'
    )

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    print("\n" + "="*70)
    print("üöÄ –ó–ê–ü–£–°–ö AI DART COACH –° YOLOv8")
    print("="*70)

    if BOT_TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–û–°–ù–û–í–ù–û–ì–û_–ë–û–¢–ê":
        print("\n‚ùå –û–®–ò–ë–ö–ê: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!")
        print("\nüîß –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω:")
        print("1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram")
        print("2. –ù–∞–π–¥–∏—Ç–µ @BotFather")
        print("3. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞: /newbot")
        print("4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω (–ø—Ä–∏–º–µ—Ä: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz)")
        print("5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ –∫–æ–¥ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 18")
        print("\nüîÑ –ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–ª–æ–∫–Ω–æ—Ç")
        return

    application = Application.builder().token(BOT_TOKEN).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.VIDEO, handle_video_analysis))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))

    print("\n‚úÖ –ë–æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print(f"\nü§ñ –¢–ï–•–ù–û–õ–û–ì–ò–Ø: {'YOLOv8 Pose Estimation' if REAL_ANALYSIS_ENABLED else 'Basic Analysis'}")
    print("\nüì± –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:")
    print("1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞")
    print("2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start")
    print("3. –ù–∞–∂–º–∏—Ç–µ 'üé¨ –û–¢–ü–†–ê–í–ò–¢–¨ –í–ò–î–ï–û –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê'")
    print("4. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ –≤–∞—à–µ–≥–æ –±—Ä–æ—Å–∫–∞ (–≤–∏–¥ —Å–±–æ–∫—É)")
    print("5. –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–µ—Ö–Ω–∏–∫–∏")

    if REAL_ANALYSIS_ENABLED:
        print("\nüéØ –í–ö–õ–Æ–ß–ï–ù –†–ï–ê–õ–¨–ù–´–ô AI-–ê–ù–ê–õ–ò–ó:")
        print("‚Ä¢ YOLOv8 Pose - –¥–µ—Ç–µ–∫—Ü–∏—è 17 –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫")
        print("‚Ä¢ –†–∞—Å—á–µ—Ç —É–≥–ª–æ–≤ —Å—É—Å—Ç–∞–≤–æ–≤ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 1¬∞")
        print("‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ –∫–∞–¥—Ä–∞–º")
        print("‚Ä¢ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å PDC —ç—Ç–∞–ª–æ–Ω–∞–º–∏")
    else:
        print("\n‚ö†Ô∏è –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –ë–ê–ó–û–í–´–ô –ê–ù–ê–õ–ò–ó:")
        print("‚Ä¢ –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        print("‚Ä¢ –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
        print("‚Ä¢ –î–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ YOLOv8")

    print("\n‚ö° –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    print("="*70)

    try:
        await application.run_polling()
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    except Exception as e:
        print(f"\n\n‚ùå –û—à–∏–±–∫–∞: {e}")